<script type="text/javascript">
    /* global RED */
    RED.nodes.registerType('Alpaca', {
        category: 'alpaca',
        color: '#EEEEEE',
        defaults: {
            name: { value: "" },
            topic: { value: "msgTopic" },
            auth: { value: "", type: "alpaca-config" }
        },
        inputs: 1,
        outputs: 1,
        icon: "alpaca.svg",
        label: function() {
            if(this.topic=="msgTopic"){
                return this.name || "Alpaca";
            }else{
                return this.name || this.topic;
            }
        }
    });
    RED.nodes.registerType('Alpaca-Websocket', {
        category: 'alpaca',
        color: '#EEEEEE',
        defaults: {
            name: { value: "" },
            socket: { value: "", type: "alpaca-websocket" },
            subscribeFor: { value: "", required: true },
            symbol: { value: "", required: true }
        },
        inputs: 0,
        outputs: 1,
        icon: "alpaca.svg",
        label: function() {
            return this.name; // || this.topic;
        }
    });
    

</script>

<!------------------------------------------------------------------------------------->
<!------------------------------------------------------------------------------------->
<!------------------------------------------------------------------------------------->
<style type="text/css">
    .copy-button{
        position: relative;
        right: 0px;
        top: 0px;
        float: right;
        box-sizing: border-box;
        background: white;
        border: 1px solid #aa6767;
        text-shadow: none;
        font-size: 12px;
        color: #666 !important;
        padding: 6px 10px;
        border-top-right-radius: 3px;
        border-bottom-left-radius: 3px;
        vertical-align: middle;
        cursor: pointer;
    }
</style>
<script type="text/x-red" data-template-name="Alpaca">
    <!-----------------API KEYS--------------------->
    <div class="form-row">
        <label for="node-input-auth"><i class="fa fa-key"></i> Auth</label>
        <input type="text" id="node-input-auth" placeholder="API Keys">
    </div>
    <!-----------------NAME--------------------->
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <!-----------------FUNCTION--------------------->
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-function"></i> Function</label>
        <select id="node-input-topic" placeholder="Function">
            <option value=	"msgTopic">	Use msg.Topic	</option>
            <option value = "getAccount"> Get Account </option>
            <option value = "getAccountConfigurations"> Get Account Configurations </option>
            <option value = "updateAccountConfigurations"> Update Account Configurations </option>
            <option value = "getAccountActivities"> Get Account Activities </option>
            <option value = "getPortfolioHistory"> Get Portfolio History </option>
            <option value = "getBarsV2"> Get Bars (V2) </option>
            <option value = "createOrder"> Create Order </option>
            <option value = "getOrders"> Get Orders </option>
            <option value = "getOrder"> Get Order </option>
            <option value = "getOrderByClientOrderId"> Get Order By Client Order Id </option>
            <option value = "replaceOrder"> Replace Order </option>
            <option value = "cancelOrder"> Cancel Order </option>
            <option value = "cancelAllOrders"> Cancel All Orders </option>
            <option value = "getPosition"> Get Position </option>
            <option value = "getPositions"> Get Positions </option>
            <option value = "closePosition"> Close Position </option>
            <option value = "closeAllPositions"> Close All Positions </option>
            <option value = "lastTrade"> Last Trade </option>
            <option value = "lastQuote"> Last Quote </option>
            <option value = "getAssets"> Get Assets </option>
            <option value = "getAsset"> Get Asset </option>
            <option value = "getCalendar"> Get Calendar </option>
            <option value = "getWatchlists"> Get Watchlists </option>
            <option value = "getWatchlist"> Get Watchlist </option>
            <option value = "addWatchlist"> Add Watchlist </option>
            <option value = "addToWatchlist"> Add To Watchlist </option>
            <option value = "updateWatchlist"> Update Watchlist </option>
            <option value = "deleteWatchlist"> Delete Watchlist </option>
            <option value = "deleteFromWatchlist"> Delete From Watchlist </option>
        </select>
        <br />
    </div>

<div class="form-row alpaca-help" style="display:none;" data-topic="msgTopic">
<pre class="highlight language-javascript"><span class="f">msg.topic = </span><button class="copy-button" type="button">Copy</button><span>
[
    "getAccount",
    "getAccountConfigurations",
    "updateAccountConfigurations",
    "getAccountActivities",
    "getPortfolioHistory",
    "getBarsV2",
    "createOrder",
    "getOrders",
    "getOrder",
    "getOrderByClientOrderId",
    "replaceOrder",
    "cancelOrder",
    "cancelAllOrders",
    "getPosition",
    "getPositions",
    "closePosition",
    "closeAllPositions",
    "lastTrade",
    "lastQuote",
    "getAssets",
    "getAsset",
    "getCalendar",
    "getWatchlists",
    "getWatchlist",
    "addWatchlist",
    "addToWatchlist",
    "updateWatchlist",
    "deleteWatchlist",
    "deleteFromWatchlist"
]</span></pre>
</div>
    <div class="form-row alpaca-help" style="display:none;" data-topic="getAccount">
<pre class="highlight language-javascript"><span class="f">{{topic}} </span>()
    => Promise&lt;Account&gt;;
<small>     ...this function takes no arguments</small></pre>
</div>
    <div class="form-row alpaca-help" style="display:none;" data-topic="getAccountConfigurations">
<pre class="highlight language-javascript"><span class="f">{{topic}} </span>()
    => Promise&lt;AccountConfiguration&gt;;
<small>     ...this function takes no arguments</small></pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="updateAccountConfigurations">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = <button class="copy-button" type="button">Copy</button><span>
{
    "dtbp_check":"entry",
    "no_shorting":false,
    "pdt_check":"entry",
    "suspend_trade":false,
    "trade_confirm_email":"none"
}</span>
    ) => Promise&lt;AccountConfiguration&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="getAccountActivities">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = <button class="copy-button" type="button">Copy</button><span>
{
    activityTypes: string | string[], // Any valid activity type
    until: Date,
    after: Date,
    direction: string,
    date: Date,
    pageSize: number,
    pageToken: string
}</span>
    ) => Promise&lt;AccountActivity[]&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="getPortfolioHistory">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = <button class="copy-button" type="button">Copy</button><span>
{
    date_start: Date,
    date_end: Date,
    period: '1M' | '3M' | '6M' | '1A' | 'all' | 'intraday',
    timeframe: '1Min' | '5Min' | '15Min' | '1H' | '1D',
    extended_hours: Boolean
}</span>
    ) => Promise&lt;PortfolioHistory&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="getBarsV2">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (<button class="copy-button" type="button">Copy</button><span>
msg.symbol = "AAPL";
msg.payload = {
    limit: number,
    start: date isoformat string yyyy-mm-ddThh:MM:ss-04:00,
    end: date isoformat string yyyy-mm-ddThh:MM:ss-04:00,
    timeframe: "1Min" | "1Hour" | "1Day"
}</span>
    ) => Promise&lt;BarsObject&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="createOrder">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = <button class="copy-button" type="button">Copy</button><span>
{
    symbol: string, // any valid ticker symbol
    qty: number,
    side: 'buy' | 'sell',
    type: 'market' | 'limit' | 'stop' | 'stop_limit' | 'trailing_stop',
    time_in_force: 'day' | 'gtc' | 'opg' | 'ioc',
    limit_price: number, // optional,
    stop_price: number, // optional,
    client_order_id: string, // optional,
    extended_hours: boolean, // optional,
    order_class: string, // optional,
    take_profit: object, // optional,
    stop_loss: object, // optional,
    trail_price: string, // optional,
    trail_percent: string // optional,
}</span>
    ) => Promise&lt;Order&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="getOrders">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = <button class="copy-button" type="button">Copy</button><span>
{
    status: 'open' | 'closed' | 'all',
    after: Date,
    until: Date,
    limit: number,
    direction: 'asc' | 'desc'
}</span>
    ) => Promise&lt;Order[]&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="getOrder">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = uuid)
    => Promise&lt;Order&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="getOrderByClientOrderId">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = string)
    => Promise&lt;Order&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="replaceOrder">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = uuid)
    => Promise&lt;Order&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="cancelOrder">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = uuid)
    => Promise</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="cancelAllOrders">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> ()
    => Promise</pre>
<small>     this function takes no arguments</small>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="getPosition">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = symbol)
    => Promise&lt;Position&gt;</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="getPositions">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> ()
    => Promise&lt;Position&gt;</pre>
<small>     this function takes no arguments</small>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="closePosition">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = symbol)
    => Promise</pre>
</div>
<div class="form-row alpaca-help" style="display:none;" data-topic="closeAllPositions">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> ()
    => Promise</pre>
<small>     this function takes no arguments</small>
</div>
<!--------<alpaca-help>----                     LAST TRADE: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="lastTrade">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = "SYMBOL" // simple string
    ) => Promise&lt;LastTradeObject&gt;</pre>
</div>
<!--------<alpaca-help>----                     LAST QUOTE: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="lastQuote">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = <span>
    "SYMBOL" // simple string
</span>
    ) => Promise&lt;LastQuoteObject&gt;</pre>
</div>
<!--------<alpaca-help>----                     GET ASSETS: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="getAssets">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = <span>
{
    status: 'active' | 'inactive',
    asset_class: string
}</span>
    ) => Promise&lt;Asset[]&gt;</pre>
</div>
<!--------<alpaca-help>----                     GET ASSET: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="getAsset">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = symbol)
    => Promise&lt;Asset&gt;</pre>
</div>
<!--------<alpaca-help>----                     GET CALENDAR: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="getCalendar">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (msg.payload = <button class="copy-button" type="button">Copy</button><span>
{
    start: Date,
    end: Date
}</span>
    ) => Promise&lt;Calendar[]&gt;</pre>
</div>
<!--------<alpaca-help>----                     GET WATCHLISTS: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="getWatchlists">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> ()
</span>
     => Promise&lt;response&gt;</pre>
<small>     this function takes no arguments</small>
</div>
<!--------<alpaca-help>----                     GET WATCHLIST: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="getWatchlist">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> (<button class="copy-button" type="button">Copy</button><span>
    msg.payload = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"</span>
    ) => Promise&lt;response&gt;</pre>
</div>
<!--------<alpaca-help>----                     ADD WATCHLIST: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="addWatchlist">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> ( <button class="copy-button" type="button">Copy</button><span>
    msg.payload.name = "myWatchList",
    msg.payload.tickers = ["SYMBOL1","SYMBOL2"] //OPTIONAL
</span>
    ) => Promise&lt;response&gt;</pre>
</div>
<!--------<alpaca-help>----                     ADD TO WATCHLIST: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="addToWatchlist">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> ( <button class="copy-button" type="button">Copy</button><span>
    msg.payload.id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    msg.payload.ticker = "SYMBOL" 
</span>
    ) => Promise&lt;response&gt;</pre>
</div>
<!--------<alpaca-help>----                     UPDATE WATCHLIST: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="updateWatchlist">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> ( <button class="copy-button" type="button">Copy</button><span>
    msg.payload.name = "myWatchList",
    msg.payload.tickers = ["SYMBOL1", "SYMBOL2"] 
</span>
    ) => Promise&lt;response&gt;</pre>
</div>
<!--------<alpaca-help>----                     DELETE WATCHLIST: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="deleteWatchlist">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> ( <button class="copy-button" type="button">Copy</button><span>
    msg.payload = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
</span>
    ) => Promise&lt;response&gt;</pre>
</div>
<!--------<alpaca-help>----                     DELETE FROM WATCHLIST: ---->
<div class="form-row alpaca-help" style="display:none;" data-topic="deleteFromWatchlist">
<pre class="highlight language-javascript"><span class="f">{{topic}}</span> ( <button class="copy-button" type="button">Copy</button><span>
    msg.payload.name = "myWatchList",
    msg.payload.ticker = "SYMBOL" 
</span>
    ) => Promise&lt;response&gt;</pre>
</div>

<script type="text/javascript">
/*global $*/
    $(document).ready(function(){
        $(".copy-button").on("click", function(evt) {
            evt.preventDefault();
            var ta = document.createElement('textarea');
            ta.value = $(this).next()[0].innerText;
            ta.style.position = 'absolute';
            ta.style.left = '-3000px';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            $(this).text("Copied!");
            var self = $(this);
            setTimeout(function() {
                self.text("Copy");
            },3000);
        });
        $("#dialog-form .form-row .highlight span.f").each(function(){
            $(this).text(function(){
                return $(this).text().replace(
                    "{{topic}}",
                    $(this).parent().parent().data("topic")
                );
            });
        });
        var showHelp = function(){
            var newTopic = $("#node-input-topic").val();
            $("#dialog-form .form-row.alpaca-help").each(function(){
                var $row = $(this);
                if($row.data("topic") == newTopic){
                    $row.show();
                }else{
                    $row.hide();
                }
            });
        };
        $("#node-input-topic").on("change", showHelp);
        $("#node-input-topic").ready(showHelp);
    });
</script>
</script>

<script type="text/x-red" data-help-name="Alpaca">
    <p>Universal node that wraps all of the </p>
    <h3>Inputs</h3>
    <p>See configuration panel for examples of each request </p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload
           <span class="property-type">object</span>
       </dt>
        <h3>Details</h3>
        <p>Payload is the full response object from the API</p>
        <dt>topic
           <span class="property-type">string</span>
       </dt>
        <h3>Details</h3>
        <p>Topic is the type of event being emitted from the node</p>
</script>

<!------------------------------------------------------------------------------------->

<script type="text/x-red" data-template-name="Alpaca-Websocket">
    <div class="form-row">
        <label for="node-input-socket"><i class="fa fa-socks"></i> WebSocket</label>
        <input type="text" id="node-input-socket">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-subscribeFor"><i class="fa fa-rss"></i> Subscribe For:</label>
        <select id="node-input-subscribeFor">
            <option value=	"quotes">	Quotes </option>
            <option value = "trades" selected> Trades </option>
            <option value = "bars"> Bars </option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-symbol"><i class="fa fa-ticket"></i> Symbol</label>
        <input type="text" id="node-input-symbol" placeholder="">
    </div>
</script>

<script type="text/x-red" data-help-name="Alpaca-Websocket">
    <p>Node for emitting events from the Alpaca Websocket V2 Client</p>
    <h3>TODO ------ Config</h3>
    <!--dl class="message-properties">
        <dt>subscribe keys
           <span class="property-type">string</span>
       </dt>
        <h3>Details</h3>
        <p>Supply a comma separated value which will be split and supplied to the function from the api</p>
        <dt>topic
           <span class="property-type">string</span>
       </dt>
    </dl-->
    <h3>TODO ------ Outputs</h3>
    <!--dl class="message-properties">
        <dt>payload
           <span class="property-type">object</span>
       </dt>
        <h3>Details</h3>
        <p>Payload is the response object from the API</p>
        <dt>topic
           <span class="property-type">string</span>
       </dt>
       <dt>topic
           <span class="property-type">object</span>
       </dt>
        <h3>Details</h3>
        <p>Payload is the response object from the API</p>
        <dt>topic
           <span class="property-type">string</span>
       </dt>
    </dl-->
        <h3>Reference</h3>
        <p><a href="https://alpaca.markets/docs/api-documentation/api-v2/market-data/alpaca-data-api-v2/">Documentation on Alpaca.Markets</a></p>
        <p><a href="https://github.com/alpacahq/alpaca-trade-api-js/blob/master/examples/websocket_example.js">SDK Example from GitHub</a></p>
</script>
